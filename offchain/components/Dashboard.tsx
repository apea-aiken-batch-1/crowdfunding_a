import { Accordion, AccordionItem } from "@nextui-org/accordion";

import { ZonedDateTime } from "@internationalized/date";

import CreatedCampaigns from "./creator/CreatedCampaigns";
import CreateCampaignButton from "./creator/CreateCampaignButton";

import AvailableCampaigns from "./backer/AvailableCampaigns";

import {
  Address,
  applyDoubleCborEncoding,
  credentialToAddress,
  Data,
  fromText,
  keyHashToCredential,
  LucidEvolution,
  paymentCredentialOf,
  SpendingValidator,
  stakeCredentialOf,
  TxSignBuilder,
  UTxO,
  validatorToAddress,
} from "@lucid-evolution/lucid";
import { CampaignDatum, CampaignRedeemerAction } from "@/types/cardano";

const Script = {
  Spend: applyDoubleCborEncoding(
    "5910f701010032323232323232323232323225333005323232323253323300b3001300d37540042646464a66666602c00c264646464a66602460060022a66602c602a6ea80285400803c54ccc048c02000454ccc058c054dd50050a8010078a99980918020008a99980b180a9baa00a1500200f00f301337540122a666020600260246ea800c4cc8c8c8c8c8c8c8c8c8c8c8c8c88c94ccc07cc0400044c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c94ccc0cc0040b44c94ccc0d0c0dc0084c94ccc0c4c088c0ccdd50008991929998199812181a9baa0011323253330353330353371e00c6eb8c090c0e0dd5007a504a22a66606a66e20c8c94ccc0dcc0b4c0e4dd5000899299981c1817181d1baa3028303b37540062002266e000052002375a607a60746ea800454cc0e1241446578706563742046696e6974652874696d65293a20496e74657276616c426f756e64547970653c506f73697854696d653e203d20626f756e642e626f756e645f747970650016302530393754002664464a666070605200220062a666070605c0022006200460726ea8c94ccc0e0c0a4004530103d879800015333038302a00114c0103d87b8000153330385333038302e303a3754605060766ea800c4c0b8c0e8dd51814181d9baa0021333038302e303a3754605060766ea80092825114c103d87a800015333038302e303a3754605060766ea800c5300103d87b800014c103d879800030393754664464a66607460560022a666074605660786ea80085300103d87a800014c103d87980001533303a302c0011533303a302c303c3754004298103d87a800014c103d87b800013232533303c302d00114c0103d87b80001533303c302e00114c0103d8798000132533303d337100060022980103d87980001533303d3370e0060022980103d87a800014c103d87b8000375a6084607e6ea8010c0f4dd50019bad3040303d375400660766ea8008c098c0e8dd50011813181d1baa001302430383754010604a60706ea802004454ccc0d4c0acc8cc00400402c894ccc0ec004520001332253330393375e607e60786ea8008c0a0c0f0dd5003099b80001480084004c0f4004cc008008c0f800454ccc0d4cc0780288c8c8c8c8c94ccc0ecc0b4c0f4dd50008991929999998228010a99981e9817181f9baa00213253330420010021325333333047001003003003003132325333045001005132533333304a001006006006132325333048001008132533333304d00100900900913232533304b00100b1325333333050001132533304d00100d132533333305200100e132533304f30520031333035004133036001225333051002132533304e3375e02e607a60a26ea806c54ccc138cdc78078170a99982719b8700c02c1533304e3370e0120542a66609c66ebc01c0a054ccc138cdc4280d2800899baf374c606c0086e98ccc888c8cc004004010894ccc15c0044cc160cdd80021ba80034bd6f7b630099191919299982b99baf33045375c608c60b46ea8020dd71823182d1baa0024c0103d879800013305c337600106ea001c01454ccc15ccdd780400109982e19bb0008375066e0001c00400c4cc170cdd80011ba800133006006003375a60b200660ae00460b600460b2002606c04e6076660a66ea407ccc14cdd480ea5eb80cdc0a800a80d0a5014a029405280a5014a02606802826464a6666660ae002264a6666660b00020280280282646660760062600a60b000c02a6eb4004050c14800804c04c04c04cc140004c14c00803c03cdd580080700700718278009827801006006006006182680098268019bad001009304a001304a003375a00200c608e002608e0066eb8004c110004c100dd50010008008008008008a503041303e37540022940c100c104008dd5981f800981f801181e800981c9baa00114a22a6606c921196d7573745f726573656e645f646174756d203f2046616c73650014a02a6606c9216b6578706563742031203d207b0a202020206c6574204f7574707574207b20616464726573732c202e2e207d203c2d206c6973742e636f756e74286f757470757473290a2020202061646472657373203d3d2063616d706169676e5f7574786f2e616464726573730a20207d001615330364913f65787065637420756e736166655f756e777261702e66696e6974655f73746172745f6f662876616c69646974795f72616e676529203c20646561646c696e650016153303649120657870656374206261636b65725f706b6820213d2063726561746f722e706b6800161301b37566048606e6ea8004c0e4c0e8c0d8dd5181c981b1baa00115330344915e65787065637420536f6d6528496e707574207b206f75747075743a2063616d706169676e5f7574786f2c202e2e207d29203d0a20202020696e70757473207c3e207472616e73616374696f6e2e66696e645f696e707574286f5f7265662900163301800902632325333033302430353754004264a666068604a606c6ea80044c064c0e8c0dcdd5000801181c981b1baa002001148900302130343754606e60686ea8c0dcc0e0c0d0dd5181b981a1baa0011533032491ff65787065637420536f6d6528496e707574207b206f75747075743a204f7574707574207b20616464726573733a206261636b65725f616464726573732c202e2e207d2c202e2e207d29203d207b0a202020206c657420696e707574203c2d206c6973742e66696e6428696e70757473290a202020207768656e20696e7075742e6f75747075742e616464726573732e7061796d656e745f63726564656e7469616c206973207b0a202020202020566572696669636174696f6e4b657928766572696669636174696f6e5f6b65795f6861736829202d3e0a2020202020202020766572696669636174696f6e5f6b65795f68617368203d3d206261636b65725f1e706b680a2020202020205f202d3e2046616c73650a202020207d0a20207d00163301c0072325333032302330343754002266e3cdd7181c181a9baa00100314a0604060686ea8c080c0d0dd51810981a1baa00102e375c606a0026eb0c0d0c0d4008c0cc004c0ccc0ccc0ccc0ccc0cc008dd61818800981898188011bac302f001302b37540446eacc0b4c0b8008c0b0004c0b0008dd6981500098150011bad30280013028002375c604c00260446ea800854ccc07cc0540044c8c8c8c94ccc08d4ccc08ccc01cdd61814981518151815181518151815181518150011bae301230263754605260546054008294454cc091241416d7573745f62655f7369676e65645f62792865787472615f7369676e61746f726965732c207369676e65723a2063726561746f722e706b6829203f2046616c73650014a02a66604664a666048602a604c6ea80044c94ccc094c05cc09cdd500089929999998170008a999813180b98141baa001132533302b001026132533333303000102702702702713232533302e001029132533333303300102a02a02a13232533303100102c132533333303600102d02d02d13232533303400102f13253333330390011325333036001031132533333303b0010321325333038303b003133301e00413301f00122533303a00213371202c646660020020089000111299981e80108008999801801982000119b80001375a6078607e00426464a666666080002264a6666660820020700700702646660480062600a608200c0726eb40040e0c0ec0080dc0dc0dc0dcc0e4004c0f00080cc0ccdd5800819019019181c000981c001018018018018181b000981b0019bad00102d30330013033003375a002054606000260600066eb8004c0b4004c0a4dd5000812812812812812981598141baa00115330264912465787065637420496e6c696e65446174756d2863616d706169676e29203d20646174756d0016302a302b302b3027375460546056604e6ea8c0a8c09cdd50008a99812a497165787065637420536f6d6528496e707574207b206f75747075743a204f7574707574207b20646174756d2c202e2e207d2c202e2e207d29203d0a202020207472616e73616374696f6e5f696e70757473207c3e207472616e73616374696f6e2e66696e645f696e707574286f5f7265662900163300900101714a22a6604892012c6d7573745f72656163685f676f616c28696e707574732c206f5f7265662c20676f616c29203f2046616c73650014a02940dd6181400098121baa01b375a604c002604c60446ea80084c8c8c8c94ccc08d4ccc08ccc01cdd618149815181518151815181518150011bae3012302637546052008294454cc091241416d7573745f62655f7369676e65645f62792865787472615f7369676e61746f726965732c207369676e65723a2063726561746f722e706b6829203f2046616c73650014a02a666046646600200200844a66605200229444c94ccc098c8c8c8cc04801c8c8c94ccc0b0cdc79808980d98179baa3032002375c6036605e6ea80144cdc398098008020a50375660626064002605a6ea8004dd69815801181480098160010998018018008a50302c00114a22a660489201296d7573745f726566756e645f616c6c286f7574707574732c206261636b65727329203f2046616c73650014a02940dd618140009814181418121baa01b3756604c604e002604c604c604c60446ea8008c080dd500b1119198008008019129998120008a5013253330213371e6eb8c09c00801052889980180180098138009299980e1806980f1baa0011375c6044603e6ea80044dd71811180f9baa001223300800223375e601860406ea80040088c94ccc06cc044c074dd50008a400026eb4c084c078dd500099299980d9808980e9baa00114c103d87a80001323300100137566044603e6ea8008894ccc084004530103d87a800013232323253330213372291100002153330213371e9101000021300e33026375000297ae014c0103d87a8000133006006003375a60460066eb8c084008c094008c08c004c8cc004004008894ccc0800045300103d87a800013232323253330203372291100002153330203371e9101000021300d33025374c00297ae014c0103d87a8000133006006003375660440066eb8c080008c090008c0880048c8cc004004008894ccc07c00452f5bded8c026644646600200200644a66604600226604800697adef6c601323253330213375e6601e6eb8c040c090dd518118029bae301030243754604600498103d87980001330260050031330260023300400400130270023025001330020023022001302100122323300100100322533301f00114a0264a6660386008604400429444cc00c00c004c0880048894ccc064c028c06cdd5001899299980f00080109929999998118008018018018018991929998108008028992999999813000803003003003099299981198130018a8040039bae00130230013023003375c002604000260386ea800c00488c8cc00400400c88cc00c004c00800888c8cc00400400c894ccc070004530103d87a800013232533301a3005002130073301f0024bd700998020020009810001180f0009ba548000894ccc050cdc80010008a60103d8798000153330143371e0040022980103d87a800014c103d87b8000230180012301730180013016301337540062944dc3a40006e1d200400b00b00b00b301330140023012001300e37540046e1d200216300f3010002300e001300e002300c001300837540022930a998032491856616c696461746f722072657475726e65642066616c73650013656153300449011f72656465656d657220616374696f6e3a2052656465656d6572416374696f6e001615330034913d657870656374205b6261636b65725f706b685d3a204c6973743c5061796d656e744b6579486173683e203d2065787472615f7369676e61746f72696573001615330024912f6578706563742043616d706169676e446174756d207b206261636b6572732c202e2e207d203d2063616d706169676e00165734ae7155ceaab9e5573eae815d0aba257481"
  ),
};
const spendingValidator: SpendingValidator = {
  type: "PlutusV3",
  script: Script.Spend,
};

export default function Dashboard(props: {
  lucid: LucidEvolution;
  address: Address;
  setActionResult: (result: string) => void;
  onError: (error: any) => void;
}) {
  const { lucid, address, setActionResult, onError } = props;

  const crowdfundingAddress = validatorToAddress(lucid.config().network, spendingValidator);

  async function submitTx(tx: TxSignBuilder) {
    const txSigned = await tx.sign.withWallet().complete();
    const txHash = await txSigned.submit();

    return txHash;
  }

  type Action = (params: any) => Promise<void>;
  type ActionGroup = Record<string, Action>;

  const actions: Record<string, ActionGroup> = {
    CampaignCreator: {
      createCampaign: async (campaign: { title: string; goal: string; deadline: ZonedDateTime }) => {
        try {
          const pkh = paymentCredentialOf(address).hash;

          const stakeAddress = await lucid.wallet().rewardAddress();
          const skh = stakeAddress ? stakeCredentialOf(stakeAddress).hash : "";

          const datum: CampaignDatum = {
            title: fromText(campaign.title),
            goal: BigInt(parseFloat(campaign.goal) * 1_000000),
            deadline: BigInt(campaign.deadline.toDate().getTime()),
            creator: { pkh, skh },
            backers: new Map(),
          };

          const tx = await lucid
            .newTx()
            .pay.ToContract(crowdfundingAddress, { kind: "inline", value: Data.to(datum, CampaignDatum) })
            .complete();

          submitTx(tx).then(setActionResult).catch(onError);
        } catch (error) {
          onError(error);
        }
      },

      finishCampaign: async ({ utxo }: { utxo: UTxO }) => {
        try {
          const tx = await lucid
            .newTx()
            .collectFrom([utxo], CampaignRedeemerAction.finish)
            .attach.SpendingValidator(spendingValidator)
            .addSigner(address)
            .complete();

          submitTx(tx).then(setActionResult).catch(onError);
        } catch (error) {
          onError(error);
        }
      },

      cancelCampaign: async ({ campaign, utxo }: { campaign: CampaignDatum; utxo: UTxO }) => {
        try {
          let newTx = lucid.newTx().collectFrom([utxo], CampaignRedeemerAction.cancel).attach.SpendingValidator(spendingValidator).addSigner(address);
          campaign.backers.forEach((lovelace, { pkh, skh }) => {
            const paymentCredential = keyHashToCredential(pkh);
            const stakeCredential = skh ? keyHashToCredential(skh) : undefined;
            const backerAddress = credentialToAddress(lucid.config().network, paymentCredential, stakeCredential);
            newTx = newTx.pay.ToAddress(backerAddress, { lovelace });
          });
          const tx = await newTx.complete();

          submitTx(tx).then(setActionResult).catch(onError);
        } catch (error) {
          onError(error);
        }
      },
    },

    Backer: {
      pledgeCampaign: async ({ pledgeAmount, campaign, utxo }: { pledgeAmount: string; campaign: CampaignDatum; utxo: UTxO }) => {
        try {
          const pkh = paymentCredentialOf(address).hash;

          const stakeAddress = await lucid.wallet().rewardAddress();
          const skh = stakeAddress ? stakeCredentialOf(stakeAddress).hash : "";

          const key = [...campaign.backers.keys()].find((key) => key.pkh === pkh && key.skh === skh) ?? { pkh, skh };
          const val = BigInt(parseFloat(pledgeAmount) * 1_000000);

          const datum: CampaignDatum = {
            ...campaign,
            backers: campaign.backers.set(key, (campaign.backers.get(key) ?? 0n) + val),
          };

          const block = await fetch("/blocks/latest", { headers: { project_id: `${process.env.NEXT_PUBLIC_BF_PID}` } });
          const { time } = await block.json();

          const tx = await lucid
            .newTx()
            .collectFrom([utxo], CampaignRedeemerAction.pledge)
            .attach.SpendingValidator(spendingValidator)
            .pay.ToContract(
              crowdfundingAddress,
              { kind: "inline", value: Data.to(datum, CampaignDatum) },
              { ...utxo.assets, lovelace: utxo.assets.lovelace + val }
            )
            .addSigner(address)
            .validFrom(time * 1_000)
            .complete();

          submitTx(tx).then(setActionResult).catch(onError);
        } catch (error) {
          onError(error);
        }
      },
    },
  };

  return (
    <div className="flex flex-col gap-2">
      <span>{address}</span>

      <Accordion variant="splitted">
        {/* CampaignCreator */}
        <AccordionItem key="1" aria-label="Accordion 1" title="Campaign Creator">
          <div className="flex flex-wrap gap-2 mb-2">
            <CreatedCampaigns
              lucid={lucid}
              address={address}
              crowdfundingAddress={crowdfundingAddress}
              finishCampaign={actions.CampaignCreator.finishCampaign}
              cancelCampaign={actions.CampaignCreator.cancelCampaign}
              onError={onError}
            />
            <CreateCampaignButton createCampaign={actions.CampaignCreator.createCampaign} onError={onError} />
          </div>
        </AccordionItem>

        {/* Backer */}
        <AccordionItem key="2" aria-label="Accordion 2" title="Pledge Campaigns">
          <div className="flex flex-wrap gap-2 mb-2">
            <AvailableCampaigns
              lucid={lucid}
              address={address}
              crowdfundingAddress={crowdfundingAddress}
              pledgeCampaign={actions.Backer.pledgeCampaign}
              onError={onError}
            />
          </div>
        </AccordionItem>
      </Accordion>
    </div>
  );
}
